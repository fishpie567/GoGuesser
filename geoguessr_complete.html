<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuessr Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        /* Menu Screen */
        #menu-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            position: relative;
        }

        .menu-left {
            width: 50%;
            padding: 80px;
            z-index: 10;
        }

        .logo {
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 80px;
            letter-spacing: 2px;
        }

        .menu-options {
            list-style: none;
        }

        .menu-option {
            color: white;
            font-size: 48px;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.2s, text-shadow 0.2s;
            text-transform: uppercase;
        }

        .menu-option:hover {
            transform: translateX(10px);
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .globe-container {
            position: absolute;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            width: 500px;
            height: 500px;
        }

        .globe {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .pin {
            position: absolute;
            top: 20%;
            right: 20%;
            width: 100px;
            height: 140px;
            background: linear-gradient(145deg, #ff4b4b, #cc0000);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .pin::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
        }

        /* Game Screen */
        #game-screen {
            display: none;
            height: 100vh;
            position: relative;
        }

        #panorama {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB, #98D8E8);
            position: relative;
            overflow: hidden;
        }

        .panorama-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Top UI */
        .top-ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .compass {
            background: rgba(100, 100, 100, 0.8);
            padding: 8px 30px;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compass-mark {
            width: 2px;
            height: 12px;
            background: white;
        }

        .compass-mark.main {
            height: 18px;
            width: 3px;
        }

        /* Right Info Panel */
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            min-width: 250px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .map-name {
            font-size: 18px;
            font-weight: bold;
            font-style: italic;
            margin-top: 5px;
        }

        .round-score {
            font-size: 32px;
            font-weight: bold;
            text-align: right;
        }

        /* Left Controls */
        .left-controls {
            position: absolute;
            left: 20px;
            bottom: 120px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(50, 50, 50, 0.9);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: rgba(70, 70, 70, 0.9);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Movement Arrows */
        .movement-arrows {
            position: absolute;
            bottom: 40%;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 900;
        }

        .arrow-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: background 0.2s;
        }

        .arrow-btn:hover {
            background: rgba(255, 255, 255, 1);
        }

        /* Minimap */
        .minimap-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        #map {
            width: 100%;
            height: calc(100% - 50px);
        }

        .guess-button {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .guess-button:hover {
            opacity: 0.9;
        }

        .guess-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Results Screen */
        #results-screen {
            display: none;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px;
            overflow-y: auto;
        }

        .results-container {
            max-width: 1200px;
            margin: 0 auto;
            color: white;
        }

        .results-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .results-header h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .total-score {
            font-size: 72px;
            font-weight: bold;
            color: #ffd700;
        }

        .rounds-summary {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .round-result {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .round-info h3 {
            margin-bottom: 10px;
        }

        .round-distance {
            font-size: 18px;
            opacity: 0.9;
        }

        .round-points {
            font-size: 36px;
            font-weight: bold;
            color: #ffd700;
        }

        .play-again-btn {
            margin-top: 40px;
            padding: 20px 60px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: transform 0.2s;
        }

        .play-again-btn:hover {
            transform: scale(1.05);
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div id="menu-screen">
        <div class="menu-left">
            <div class="logo">GEüåçGUESSR</div>
            <ul class="menu-options">
                <li class="menu-option" onclick="startGame('singleplayer')">Singleplayer</li>
                <li class="menu-option" onclick="alert('Coming soon!')">Multiplayer</li>
                <li class="menu-option" onclick="alert('Coming soon!')">Party</li>
                <li class="menu-option" onclick="alert('Coming soon!')">Quiz</li>
            </ul>
        </div>
        <div class="globe-container">
            <div class="globe">
                <div class="pin"></div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <div id="panorama">
            <img class="panorama-image" id="location-image" src="" alt="Location">
            <div class="loading" id="loading">Loading location...</div>
        </div>

        <!-- Top UI -->
        <div class="top-ui">
            <div class="compass" id="compass">
                <span class="compass-mark"></span>
                <span class="compass-mark main"></span>
                <span>N</span>
                <span class="compass-mark main"></span>
                <span class="compass-mark"></span>
                <span class="compass-mark"></span>
                <span class="compass-mark main"></span>
                <span>E</span>
                <span class="compass-mark main"></span>
                <span class="compass-mark"></span>
                <span class="compass-mark"></span>
                <span class="compass-mark main"></span>
                <span>S</span>
                <span class="compass-mark main"></span>
                <span class="compass-mark"></span>
            </div>
        </div>

        <!-- Right Info Panel -->
        <div class="info-panel">
            <div class="info-row">
                <span>Map</span>
                <span>Round</span>
                <span>Score</span>
            </div>
            <div class="info-row">
                <span class="map-name" id="map-name">Famous Places</span>
                <span class="round-score"><span id="current-round">1</span> / 5</span>
                <span class="round-score" id="total-score">0</span>
            </div>
        </div>

        <!-- Left Controls -->
        <div class="left-controls">
            <div class="control-group">
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
            </div>
            <button class="control-btn" onclick="returnToStart()" title="Return to Start">‚Ü∫</button>
            <button class="control-btn" onclick="setCheckpoint()" title="Set Checkpoint">üìç</button>
            <button class="control-btn" onclick="undoMove()" title="Undo">‚Ü∂</button>
            <button class="control-btn" onclick="openSettings()" title="Settings">‚öô</button>
        </div>

        <!-- Minimap -->
        <div class="minimap-container">
            <div id="map"></div>
            <button class="guess-button" id="guess-btn" onclick="makeGuess()" disabled>
                Place your pin on the map
            </button>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen">
        <div class="results-container">
            <div class="results-header">
                <h1>Game Complete!</h1>
                <div class="total-score" id="final-score">0</div>
                <p>Total Points</p>
            </div>
            <div class="rounds-summary" id="rounds-summary"></div>
            <button class="play-again-btn" onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script>
        // Game State
        let currentRound = 1;
        let totalScore = 0;
        let roundResults = [];
        let locations = [];
        let currentLocation = null;
        let map, marker, actualLocationMarker;
        let guessLat = null;
        let guessLng = null;

        // Initialize Leaflet Map
        function initMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                zoomControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Click to place marker
            map.on('click', function(e) {
                guessLat = e.latlng.lat;
                guessLng = e.latlng.lng;
                
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker([guessLat, guessLng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                document.getElementById('guess-btn').disabled = false;
                document.getElementById('guess-btn').textContent = 'MAKE GUESS';
            });
        }

        // Fetch locations from API
        async function fetchLocations() {
            try {
                const response = await fetch('https://map-degen.vercel.app/api/maps');
                const data = await response.json();
                
                // Get a random map or use a specific one
                const maps = data.maps || [];
                if (maps.length > 0) {
                    // Try to find "Famous Places" or similar
                    let selectedMap = maps.find(m => m.name.includes('Famous') || m.name.includes('World'));
                    if (!selectedMap) selectedMap = maps[0];
                    
                    // Fetch the specific map data
                    const mapResponse = await fetch(`https://map-degen.vercel.app/api/maps/${selectedMap.id}`);
                    const mapData = await mapResponse.json();
                    
                    locations = mapData.locations || [];
                    document.getElementById('map-name').textContent = selectedMap.name;
                    
                    // Shuffle locations
                    locations = locations.sort(() => Math.random() - 0.5).slice(0, 5);
                } else {
                    // Fallback to demo locations
                    useDemoLocations();
                }
            } catch (error) {
                console.error('Error fetching locations:', error);
                useDemoLocations();
            }
        }

        function useDemoLocations() {
            locations = [
                {
                    lat: 51.1789,
                    lng: -1.8262,
                    panoId: null,
                    heading: 0,
                    pitch: 0,
                    zoom: 0
                },
                {
                    lat: 41.8902,
                    lng: 12.4922,
                    panoId: null,
                    heading: 0,
                    pitch: 0,
                    zoom: 0
                },
                {
                    lat: 48.8584,
                    lng: 2.2945,
                    panoId: null,
                    heading: 0,
                    pitch: 0,
                    zoom: 0
                },
                {
                    lat: 40.6892,
                    lng: -74.0445,
                    panoId: null,
                    heading: 0,
                    pitch: 0,
                    zoom: 0
                },
                {
                    lat: 27.1751,
                    lng: 78.0421,
                    panoId: null,
                    heading: 0,
                    pitch: 0,
                    zoom: 0
                }
            ];
        }

        // Start Game
        async function startGame(mode) {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            initMap();
            await fetchLocations();
            loadRound();
        }

        // Load Round
        function loadRound() {
            if (currentRound > 5) {
                showResults();
                return;
            }

            currentLocation = locations[currentRound - 1];
            document.getElementById('current-round').textContent = currentRound;
            
            // Clear previous markers
            if (marker) map.removeLayer(marker);
            if (actualLocationMarker) map.removeLayer(actualLocationMarker);
            marker = null;
            actualLocationMarker = null;
            guessLat = null;
            guessLng = null;
            
            document.getElementById('guess-btn').disabled = true;
            document.getElementById('guess-btn').textContent = 'PLACE YOUR PIN ON THE MAP';
            
            // Reset map view
            map.setView([20, 0], 2);
            
            // Load location image (using a placeholder service)
            const img = document.getElementById('location-image');
            document.getElementById('loading').style.display = 'block';
            img.style.display = 'none';
            
            // Use Google Street View Static API or placeholder
            img.src = `https://maps.googleapis.com/maps/api/streetview?size=1200x800&location=${currentLocation.lat},${currentLocation.lng}&heading=${currentLocation.heading || 0}&pitch=${currentLocation.pitch || 0}&key=YOUR_API_KEY_HERE`;
            
            // Fallback to a colored placeholder
            img.onerror = function() {
                this.style.display = 'none';
                document.getElementById('panorama').style.background = `linear-gradient(${Math.random() * 360}deg, #667eea 0%, #764ba2 100%)`;
                document.getElementById('loading').textContent = `Round ${currentRound} - Make your guess!`;
            };
            
            img.onload = function() {
                document.getElementById('loading').style.display = 'none';
                this.style.display = 'block';
            };
        }

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate score based on distance
        function calculateScore(distance) {
            // Using exponential decay: score = round(5000 * exp(-k * d))
            const k = 0.000067; // Fitted constant for "World" map
            const score = Math.round(5000 * Math.exp(-k * distance * 1000));
            return Math.max(0, Math.min(5000, score));
        }

        // Make Guess
        function makeGuess() {
            if (guessLat === null || guessLng === null) return;

            const distance = calculateDistance(
                currentLocation.lat,
                currentLocation.lng,
                guessLat,
                guessLng
            );

            const roundScore = calculateScore(distance);
            totalScore += roundScore;

            // Show actual location on map
            actualLocationMarker = L.marker([currentLocation.lat, currentLocation.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);

            // Draw line between guess and actual
            L.polyline([
                [guessLat, guessLng],
                [currentLocation.lat, currentLocation.lng]
            ], {
                color: 'red',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Fit map to show both markers
            map.fitBounds([
                [guessLat, guessLng],
                [currentLocation.lat, currentLocation.lng]
            ], { padding: [50, 50] });

            // Store result
            roundResults.push({
                round: currentRound,
                distance: distance.toFixed(2),
                score: roundScore
            });

            // Update UI
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('guess-btn').textContent = `${roundScore} points! Click for next round`;
            document.getElementById('guess-btn').onclick = nextRound;
        }

        // Next Round
        function nextRound() {
            currentRound++;
            document.getElementById('guess-btn').onclick = makeGuess;
            loadRound();
        }

        // Show Results
        function showResults() {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            document.getElementById('final-score').textContent = totalScore;

            const summaryDiv = document.getElementById('rounds-summary');
            summaryDiv.innerHTML = '';

            roundResults.forEach(result => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round-result';
                roundDiv.innerHTML = `
                    <div class="round-info">
                        <h3>Round ${result.round}</h3>
                        <p class="round-distance">Distance: ${result.distance} km</p>
                    </div>
                    <div class="round-points">${result.score}</div>
                `;
                summaryDiv.appendChild(roundDiv);
            });
        }

        // Control Functions
        function zoomIn() {
            const img = document.getElementById('location-image');
            const currentScale = img.style.transform ? parseFloat(img.style.transform.replace('scale(', '')) : 1;
            img.style.transform = `scale(${Math.min(currentScale + 0.2, 3)})`;
        }

        function zoomOut() {
            const img = document.getElementById('location-image');
            const currentScale = img.style.transform ? parseFloat(img.style.transform.replace('scale(', '')) : 1;
            img.style.transform = `scale(${Math.max(currentScale - 0.2, 1)})`;
        }

        function returnToStart() {
            const img = document.getElementById('location-image');
            img.style.transform = 'scale(1)';
        }

        function setCheckpoint() {
            alert('Checkpoint set at current position!');
        }

        function undoMove() {
            alert('Returned to previous position!');
        }

        function openSettings() {
            alert('Settings panel - Coming soon!');
        }
    </script>
</body>
</html>